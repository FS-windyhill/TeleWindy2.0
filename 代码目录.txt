/**
 * TeleWindy Core Logic - 完整模块目录（详细版）
 * 
 * 1. CONFIG & STATE          —— 全局配置常量 + 运行时状态
 *    ├─ CONFIG                 : 所有常量、默认值、STORAGE_KEY、SYSTEM_PROMPT 等
 *    └─ STATE                  : 运行时全局状态（contacts、worldInfoBooks、currentContactId、currentBookId、settings、isTyping）
 * 
 * 1.5. DB UTILS (IndexedDB 封装)
 *    ├─ open()                 : 打开/创建 IndexedDB 数据库
 *    ├─ get(key)               : 读取一条数据
 *    ├─ set(key, value)        : 写入/更新一条数据
 *    ├─ remove(key)            : 删除一条数据
 *    ├─ clear()                : 清空整个数据库
 *    └─ exportAll()            : 导出数据库中所有键值对（用于备份）
 * 
 * 2. STORAGE SERVICE         —— 数据持久化核心（基于 IndexedDB + 兼容旧 LocalStorage 迁移）
 *    ├─ load()                 : 初始化时加载所有数据（settings、contacts、worldInfoBooks）+ 自动迁移旧版数据
 *    ├─ saveContacts()         : 保存联系人列表
 *    ├─ saveSettings()         : 保存全局设置
 *    ├─ saveWorldInfo()        : 保存所有世界书
 *    ├─ exportAllForBackup()   : 导出完整备份（Token 会加密处理）
 *    └─ importFromBackup(data) : 导入备份（自动清库 → 解密 Token → 写入）
 * 
 * 3. WORLD INFO ENGINE       —— ★★★ 世界书（World Book）核心逻辑（大分类 + 条目）
 *    ├─ importFromST(jsonString, fileName) : 导入 SillyTavern 格式的世界书 → 生成 Book 对象
 *    ├─ exportToST(book)       : 导出当前书为标准 SillyTavern JSON
 *    └─ scan(userText, history, currentContactId, currentContactName)
 *        → 核心触发逻辑：只扫描最近两条对话，判断全局书/绑定书 → 检查 constant 或 key 是否命中 → 返回注入的 world info 文本
 * 
 * 4. API SERVICE             —— 与大模型通信的核心封装（兼容 OpenAI / Claude / Gemini）
 *    ├─ getProvider(url)       : 根据 URL 判断是哪家供应商
 *    ├─ fetchModels(url, key)  : 拉取模型列表
 *    └─ chat(messages, settings) : 统一发送聊天请求（自动适配三种格式）
 * 
 * 5. CLOUD SYNC              —— 云端备份/恢复（Gist + 自定义服务器 双模式）
 *    ├─ init()                 : 初始化 UI 与历史选择
 *    ├─ toggleMode()           : 切换 Gist / 自定义服务器 模式
 *    ├─ findBackup()           : 【Gist 专属】自动搜索用户的所有 Gist，找到 TeleWindy 备份
 *    ├─ updateBackup()         : 主入口：根据当前模式执行上传
 *    ├─ restoreBackup()        : 主入口：根据当前模式执行恢复
 *    ├─ _uploadToCustom() / _fetchFromCustom() : 自定义服务器上传/下载
 *    ├─ _uploadToGist() / _fetchFromGist()     : GitHub Gist 上传/下载
 *    ├─ _preparePayload()      : 上传前数据混淆（Token 加密防泄露）
 *    ├─ _safeRestore()         : 安全恢复（自动解密 Token + 保留同步设置）
 *    └─ 其他辅助：_maskToken / _unmaskToken / showStatus / getAuth 等
 * 
 * 6. UI RENDERER             —— 所有 DOM 操作与界面渲染
 *    ├─ init()                 : 初始化外观 + 渲染联系人 + 云同步初始化
 *    ├─ applyAppearance()      : 应用壁纸 + 主题
 *    ├─ toggleTheme()          : 切换明暗模式并保存
 *    ├─ switchView()           : 联系人列表 ↔ 聊天窗口 切换
 *    ├─ renderContacts()       : 渲染左侧联系人列表
 *    ├─ renderBookSelect()     : 渲染世界书下拉框（大分类）
 *    ├─ renderWorldInfoList()  : 渲染当前书的条目列表 + 高亮当前编辑项
 *    ├─ initWorldInfoTab()     : 世界书标签页首次打开时的完整初始化
 *    ├─ renderChatHistory()    : 渲染聊天记录（含时间戳清理）
 *    ├─ appendMessageBubble()  : 添加单条消息气泡（自动处理头像、时间）
 *    ├─ playWaterfall()        : AI 回复逐段渐现动画
 *    ├─ setLoading()           : “正在输入…” 状态
 *    ├─ removeLatestAiBubbles(): 删除最后几条 AI 消息（用于重滚）
 *    ├─ updateRerollState()    : 更新“重滚”按钮可用性
 *    └─ renderPresetMenu()     : 渲染 API 预设下拉菜单
 * 
 * 7. APP CONTROLLER          —— 核心业务逻辑 + 所有事件绑定
 *    ├─ init()                 : 程序入口（load → UI.init → 绑定事件）
 *    ├─ enterChat(id)          : 进入指定联系人聊天
 *    ├─ handleSend(isReroll)   : 发送消息主逻辑（含 reroll、重滚）
 *    ├─ openSettings()         : 打开主设置弹窗并填充当前值 + 初始化世界书 Tab
 *    ├─ 世界书相关系列函数：
 *        ├─ switchWorldInfoBook()          : 切换当前编辑的书
 *        ├─ bindCurrentBookToChar()        : 把当前书绑定到某个角色（或全局）
 *        ├─ loadWorldInfoEntry() / saveWorldInfoEntry() / deleteWorldInfoEntry()
 *        ├─ clearWorldInfoEditor()
 *        ├─ createNewBook() / renameCurrentBook() / deleteCurrentBook()
 *        ├─ exportCurrentBook() / handleImportWorldInfo()
 *    ├─ API 预设相关：handleSavePreset / handleLoadPreset / handleDeletePreset
 *    ├─ saveSettingsFromUI()   : 从设置弹窗保存所有配置
 *    ├─ fetchModelsForUI()     : 拉取模型列表按钮回调
 *    ├─ openEditModal() / saveContactFromModal() : 角色的新建/编辑
 *    ├─ bindEvents()           : 一次性绑定页面上几乎所有按钮、输入框事件（超级长的一个函数）
 *    └─ 其他工具：readFile / bindImageUpload 等
 * 
 * 8. UTILS & GLOBAL FUNCTIONS
 *    ├─ formatTimestamp()      : 生成 [Dec.12 14:23] 格式时间戳
 *    ├─ window.exportData()    : 全局导出备份按钮调用
 *    └─ window.importData()    : 全局导入备份按钮调用（含空间检测、超限警告、自动刷新）
 * 
 * 启动入口：window.onload = () => App.init();
 */